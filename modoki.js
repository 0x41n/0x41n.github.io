const modoki={toc:[],decode(t){this.toc=[];let r="",o=0,a=(t,e,r)=>t.replace(e,r),l=(t,e)=>`<${e}>${t}</${e}>`,i=t.trim().split("\n"),g=[/^(\s*)([-*]|[+*]|\d+\.)\s+(.*)/,/^>\s?(.*)/,/^\|(.+)\|$/],m=(t,e)=>t.startsWith(e),$=(t,e)=>t.endsWith(e),h=t=>t.length,n=t=>[...t].map(t=>`&#${t.codePointAt(0)};`).join(""),p=r=>{return[[/audio\[(.*?)\]\((.+?)\)/g,"<audio src='$2'controls nodownload>$1</audio>"],[/video\[(.*?)\]\((.+?)\)/g,"<video src='$2'controls nodownload>$1</video>"],[/---/g,"<hr>"],[/~~(.+?)~~/g,"<span style=text-decoration:line-through>$1</span>"],[/\[\[(.+?)\]\]/g,"<iframe src='$1'></iframe>"],[/\{(.+?)\|(.+?)\}/g,"<ruby>$1<rt>$2</rt></ruby>"],[/:([a-zA-Z0-9_-]+?):/g,'<i class="i-$1"></i>']].forEach(([t,e])=>r=r.replace(t,e)),r=(r=(r=r.replace(/!\[(.*?)\]\((\S+?)(?:\s+"(.*?)")?\)/g,(t,e,r,o)=>`<img src='${r}' alt='${e}'${o?` title='${o}'`:""}>`)).replace(/\[([^\]]+)\]\(([^()\s]+(?:\([^)]*\)[^()\s]*)*)\)/g,(t,e,r)=>{r=(t=>{t=encodeURI(t);let e,r=[..."*~^[](){}_"];for(e of r)t=a(t,new RegExp("\\"+e,"g"),"%"+e.charCodeAt(0).toString(16));return t})(r.trim());return`<a href='${r}'${m(r,"http")?' target="_blank" rel="noopener noreferrer"':""}>${e}</a>`})).replace(/`(.+?)`/g,(t,e)=>l(n(e),"code")),[[/\*\*(.+?)\*\*/g,"strong"],[/\*(.+?)\*/g,"em"],[/__(.+?)__/g,"u"],[/_(.+?)_/g,"small"],[/\^(.+?)\^/g,"sup"],[/~(.+?)~/g,"sub"]].forEach(([t,e])=>{r=r.replace(t,l("$1",e))}),r};for(;o<i.length;){let t=i[o].trim(),e;var s,c,d;""==t?(r+="<br>",o++):("[more]"!=t.toLowerCase()&&(/^<https?:\/\/.+>$/.test(t)?r+=`<a class=linkcard-placeholder href='${t.slice(1,-1)}'target='_blank'rel='noopener noreferrer'><p>${t.slice(1,-1)}</p></a>`:/^<<.+>>$/.test(t)?(s=t.slice(2,-2).split(""),r+=this.linkcard(s[0],s[1],s[2],s[3],s[4],"linkcard linkcard-placeholder")):(s=t.match(/^(#{1,6})\s*(.+)$/))?(e=s[1].length,c=p(s[2]),d=a(this.clean(s[2]),/\s/g,""),r+=`<h${e} id='${d}'>${c}</h${e}>`,this.toc.push({level:e,id:d,text:this.clean(s[2])})):g[0].test(t)?(e=(t=>{let e="",r=0,o=[],a,i,l,n=[];for(;r<h(t)&&(a=t[r].match(g[0]));r++){for(i=h(a[1]),l=/^\d+\./.test(a[2])?"ol":"ul";h(o)&&o[h(o)-1][0]>=i;)n=o.pop(),e+="</li>"+(n[0]>i||n[1]!=l?`</${n[1]}>`:"");e+=(n[0]!=i||n[1]!=l?`<${l}>`:"")+"<li>"+p(a[3]),o.push([i,l])}for(;h(o);)e+=`</li></${o.pop()[1]}>`;return[e,r-1]})(i.slice(o)),r+=e[0],o+=e[1]):g[1].test(t)?(e=(t=>{let e="",r=0,o,a;for(o of t){if(!(a=o.match(g[1])))break;e+=p(a[1])+"<br>",r++}return[l(e,"blockquote"),r-1]})(i.slice(o)),r+=e[0],o+=e[1]):g[2].test(t)?(e=(t=>{let o="<table><tr>",e=2,r=t[0]?.match(g[2]),a=t[1]?.match(g[2]),i,l,n,s,c,d={};if(!r||!a)return["",0];for(r=r[1].split("|"),a=a[1].split("|").map(t=>m(t,":")?$(t,":")?"center":"left":$(t,":")?"right":null),r.forEach((t,e)=>o+=`<th${a[e]?` style='text-align:${a[e]}'`:""}>${t}</th>`),o+="</tr>";e<h(t)&&g[2].test(t[e])&&(o+="<tr>",s=t[e].match(g[2]));){n=s[1].split("|"),c=0;for(i of n){i=i.trim();let e=1,r=1;for(;m(i,"^");)i=i.slice(1),e++;for(;m(i,">");)i=i.slice(1),r++;for(;d[c];)d[c]--,c++;if(l="",1<e){for(let t=0;t<r;t++)d[c+t]=e-1;l+=`rowspan="${e}"`}1<r&&(l+=`colspan="${r}"`),o+=`<td ${a[c]?`style='text-align:${a[c]}'`:""}${l}>${p(i)}</td>`,c+=r}o+="</tr>",e++}return[o+"</table>",e-1]})(i.slice(o)),r+=e[0],o+=e[1]):m(t,"```")?(e=(t=>{let e=t[0].slice(3).trim(),r="",o=1;for(;o<h(t)&&!m(t[o],"```");)r+=t[o]+"\n",o++;return[l(`<code${e?` class="language-${e}"`:""}>${n(r.trim())}</code>`,"pre"),o]})(i.slice(o)),r+=e[0],o+=e[1]):m(t,":::")?(e=(t=>{let e=t[0].match(/^:::\s*(\w+)(?:\s+(.*))?$/),r,o,a=[],i=1;if(!e)return["",0];for(r=e[1],o=e[2]||"";i<h(t)&&!m(t[i],":::");)a.push(p(t[i])),i++;return a=a.join("<br>"),"details"==r?[l(l(o||"詳細","summary")+a,"details"),i]:[`<div class='${r}'>${l(o||r,"strong")}<br>${a}</div>`,i]})(i.slice(o)),r+=e[0],o+=e[1]):r+=p(t)+"<br>"),o++)}return r},clean(r){return[[/!\[(.*?)\]\((.*?)\)/g,"$1"],[/\[([^\]]+)\]\(((?:[^()\\]|\\.)+|\((?:[^()\\]|\\.)*\))*\)/g,"$1"],[/\*\*(.+?)\*\*/g,"$1"],[/\*(.+?)\*/g,"$1"],[/~~(.+?)~~/g,"$1"],[/~(.+?)~/g,"$1"],[/\^(.+?)\^/g,"$1"],[/`(.+?)`/g,"$1"],[/__(.+?)__/g,"$1"],[/_(.+?)_/g,"$1"],[/\{(.+?)\|(.+?)\}/g,"$1"],[/\:([a-zA-Z0-9_-]+?)\:/g,""],[/\[\[(.+?)\]\]/g,""],[/---/g,""],[/^>\s?/gm,""],[/^(\s*)([-*+]|[0-9]+\.)\s+/gm,""],[/^\|(.+)\|$/gm,""],[/^#{1,6}\s*/gm,""],[/^:::\s*(\w+)(?:\s+.*)?$/gm,""],[/^:::\s*$/gm,""],[/^```.*$/gm,""],[/^```$/gm,""],[/<\/?[^>]+>/g,""]].forEach(([t,e])=>r=r.replace(t,e)),r},preview(t){let e=t.split("\n"),r=[],o;for(o of e){if("[more]"==o.trim().toLowerCase())break;r.push(o)}return this.clean(r.join("\n").trim()).trim().replace(/\n/g," ")},meta(t){let e={},r=t.trim().split("\n"),o=0,a;if("---"==r[0].trim()){for(o++;o<r.length&&"---"!=r[o].trim();)(a=r[o].trim().match(/^(\w+):\s*(.+)$/))&&(e[a[1]]=a[2]),o++;o++}return e.tags&&(e.tags=e.tags.split(",").map(t=>t.trim())),e.body=r.slice(o).join("\n").trim(),e},async ogp(t){var e=await(await fetch("https://corsproxy.io/?"+t)).text(),e=(new DOMParser).parseFromString(e,"text/html"),r={};for(const i of Array.from(e.head.querySelectorAll("meta[property]"))){var o=i.getAttribute("property"),a=i.getAttribute("content");o&&a&&(r[o]=a)}return r["og:title"]||=e.querySelector("title")?.textContent?.trim(),r["og:description"]||=e.querySelector('meta[name="description"]')?.getAttribute("content")?.trim(),r.ori=t,r},async hydrate(){for(const e of document.querySelectorAll(".linkcard-placeholder")){var t={...await this.ogp(e.getAttribute("href"))};e.outerHTML=this.linkcard(t["og:title"]||t["twitter:title"]||"リンク",t["og:description"]||t["twitter:description"]||"",t["og:image"]||t["twitter:image"],t["og:url"]||t["twitter:url"]||"",t.ori)}},linkcard(t,e,r,o,a,i="linkcard"){return`<a href=${a=a||o} class='${i}'target=_blank rel='noopener noreferrer'><span><div class='lttl nowrap'>${t}</div><div class='ldsc nowrap'>${e}</div>${o?`<div class='lurl nowrap'>${o}</div>`:""}</span>${r?`<img src='${r}'alt='${t}'>`:""}</a>`.trim()},genToc(){return this.toc.map(t=>`<a href="#${t.id}"class=toc-${t.level}>${t.text}</a>`)}};async function render(){var t=document.getElementById("source")?.textContent||"",e=modoki.meta(t),t=modoki.decode(e.body),r=await(await fetch(e.template||"/templates/default.html")).text(),o=(new DOMParser).parseFromString(r,"text/html"),a=(t,o)=>(t=(t=(t=t.replace(/\{if (\w+)\}([\s\S]*?)\{\/if\}/g,(t,e,r)=>o[e]?r:"")).replace(/\{tags\}/g,t=>Array.isArray(o.tags)?o.tags.map(t=>`<a href="/index.html#tag=${encodeURIComponent(t)}">#${t}</a>`).join(" "):"")).replace(/\{toc\}/g,t=>modoki.genToc().join(""))).replace(/\{(\w+)\}/g,(t,e)=>o[e]||"");for(const c of o.head.children){var i=c.cloneNode(!0);for(const d of["content","href"])i.hasAttribute(d)&&i.setAttribute(d,a(i.getAttribute(d),e));var l=c.tagName.toLowerCase(),l="meta"==l&&i.hasAttribute("name")?`meta[name="${i.getAttribute("name")}"]`:"link"==l&&i.hasAttribute("href")?`link[href="${i.getAttribute("href")}"]`:"title"==l?"title":null;l&&document.head.querySelector(l)||document.head.appendChild(i)}r=a(r,{...e,body:t});document.documentElement.innerHTML=r;for(const g of o.querySelectorAll("script")){var n=document.createElement("script"),s=g.src?"src":"textContent";n[s]=a(g[s],e),document.body.appendChild(n)}await loadCommon("#foot",e.foot||"/templates/foot.html"),await modoki.hydrate()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",render):render();let c=null;onscroll=onresize=t=>{let e=[...document.querySelectorAll("main h1[id],main h2[id]")],r=scrollY,o=innerHeight,a=r+.4*o,i=null;for(let t=0;t<e.length;t++){var l,n=r+e[t].getBoundingClientRect().top;0==t?n-r<.4*o&&(i=e[t].id):(l=t+1<e.length?r+e[t+1].getBoundingClientRect().top:document.body.scrollHeight,n<=a&&a<=l&&(i=e[t].id))}var s;i!=c&&(c=i,document.querySelectorAll(".toc a").forEach(t=>t.classList.remove("active")),c)&&(s=document.querySelector(`.toc a[href="#${c}"]`))&&s.classList.add("active")},onresize();