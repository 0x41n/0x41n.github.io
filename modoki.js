const modoki={toc:[],decode(e){this.toc=[];let r="",o=0,a=(e,t,r)=>e.replace(t,r),i=(e,t)=>`<${t}>${e}</${t}>`,l=e.trim().split("\n"),m=[/^(\s*)([-*]|[+*]|\d+\.)\s+(.*)/,/^>\s?(.*)/,/^\|(.+)\|$/],g=(e,t)=>e.startsWith(t),p=(e,t)=>e.endsWith(t),u=e=>e.length,n=e=>[...e].map(e=>`&#${e.codePointAt(0)};`).join(""),h=r=>{return[[/audio\[(.*?)\]\((.+?)\)/g,"<audio src='$2'controls nodownload>$1</audio>"],[/video\[(.*?)\]\((.+?)\)/g,"<video src='$2'controls nodownload>$1</video>"],[/---/g,"<hr>"],[/~~(.+?)~~/g,"<span style=text-decoration:line-through>$1</span>"],[/\[\[(.+?)\]\]/g,"<iframe src='$1'></iframe>"],[/\{(.+?)\|(.+?)\}/g,"<ruby>$1<rt>$2</rt></ruby>"],[/:([a-zA-Z0-9_-]+?):/g,'<i class="i-$1"></i>']].forEach(([e,t])=>r=r.replace(e,t)),r=(r=(r=r.replace(/!\[(.*?)\]\((\S+?)(?:\s+"(.*?)")?\)/g,(e,t,r,o)=>`<img src='${r}' alt='${t}'${o?` title='${o}'`:""}>`)).replace(/\[([^\]]+)\]\(([^()\s]+(?:\([^)]*\)[^()\s]*)*)\)/g,(e,t,r)=>{r=(e=>{e=encodeURI(e);let t,r=[..."*~^[](){}_"];for(t of r)e=a(e,new RegExp("\\"+t,"g"),"%"+t.charCodeAt(0).toString(16));return e})(r.trim());return`<a href='${r}'${g(r,"http")?' target="_blank" rel="noopener noreferrer"':""}>${t}</a>`})).replace(/`(.+?)`/g,(e,t)=>i(n(t),"code")),[[/\*\*(.+?)\*\*/g,"strong"],[/\*(.+?)\*/g,"em"],[/__(.+?)__/g,"u"],[/_!(.+?)!_/g,"small"],[/\^(.+?)\^/g,"sup"],[/~(.+?)~/g,"sub"]].forEach(([e,t])=>{r=r.replace(e,i("$1",t))}),r};for(;o<l.length;){let e=l[o].trim(),t;var c,s,d;""==e?(r+="<br>",o++):("[more]"!=e.toLowerCase()&&(/^<https?:\/\/.+>$/.test(e)?r+=`<a class=linkcard-placeholder href='${e.slice(1,-1)}'target='_blank'rel='noopener noreferrer'><p>${e.slice(1,-1)}</p></a>`:/^<<.+>>$/.test(e)?(c=e.slice(2,-2).split(""),r+=this.linkcard(c[0],c[1],c[2],c[3],c[4],"linkcard linkcard-placeholder")):(c=e.match(/^(#{1,6})\s*(.+)$/))?(t=c[1].length,s=h(c[2]),d=a(this.clean(c[2]),/\s/g,""),r+=`<h${t} id='${d}'>${s}</h${t}>`,this.toc.push({level:t,id:d,text:this.clean(c[2])})):m[0].test(e)?(t=(e=>{let t="",r=0,o=[],a,l,i,n=[];for(;r<u(e)&&(a=e[r].match(m[0]));r++){for(l=u(a[1]),i=/^\d+\./.test(a[2])?"ol":"ul";u(o)&&o[u(o)-1][0]>=l;)n=o.pop(),t+="</li>"+(n[0]>l||n[1]!=i?`</${n[1]}>`:"");t+=(n[0]!=l||n[1]!=i?`<${i}>`:"")+"<li>"+h(a[3]),o.push([l,i])}for(;u(o);)t+=`</li></${o.pop()[1]}>`;return[t,r-1]})(l.slice(o)),r+=t[0],o+=t[1]):m[1].test(e)?(t=(e=>{let t="",r=0,o,a;for(o of e){if(!(a=o.match(m[1])))break;t+=h(a[1])+"<br>",r++}return[i(t,"blockquote"),r-1]})(l.slice(o)),r+=t[0],o+=t[1]):m[2].test(e)?(t=(e=>{let o="<table><tr>",t=2,r=e[0]?.match(m[2]),a=e[1]?.match(m[2]),l,i,n,c,s,d={};if(!r||!a)return["",0];for(r=r[1].split("|"),a=a[1].split("|").map(e=>g(e,":")?p(e,":")?"center":"left":p(e,":")?"right":null),r.forEach((e,t)=>o+=`<th${a[t]?` style='text-align:${a[t]}'`:""}>${e}</th>`),o+="</tr>";t<u(e)&&m[2].test(e[t])&&(o+="<tr>",c=e[t].match(m[2]));){n=c[1].split("|"),s=0;for(l of n){l=l.trim();let t=1,r=1;for(;g(l,"^");)l=l.slice(1),t++;for(;g(l,">");)l=l.slice(1),r++;for(;d[s];)d[s]--,s++;if(i="",1<t){for(let e=0;e<r;e++)d[s+e]=t-1;i+=`rowspan="${t}"`}1<r&&(i+=`colspan="${r}"`),o+=`<td ${a[s]?`style='text-align:${a[s]}'`:""}${i}>${h(l)}</td>`,s+=r}o+="</tr>",t++}return[o+"</table>",t-1]})(l.slice(o)),r+=t[0],o+=t[1]):g(e,"```")?(t=(e=>{let t=e[0].slice(3).trim(),r="",o=1;for(;o<u(e)&&!g(e[o],"```");)r+=e[o]+"\n",o++;return[i(`<code${t?` class="language-${t}"`:""}>${n(r.trim())}</code>`,"pre"),o]})(l.slice(o)),r+=t[0],o+=t[1]):g(e,":::")?(t=(e=>{let t=e[0].match(/^:::\s*(\w+)(?:\s+(.*))?$/),r,o,a=[],l=1;if(!t)return["",0];for(r=t[1],o=t[2]||"";l<u(e)&&!g(e[l],":::");)a.push(h(e[l])),l++;return a=a.join("<br>"),"details"==r?[i(i(o||"詳細","summary")+a,"details"),l]:[`<div class='${r}'>${i(o||r,"strong")}<br>${a}</div>`,l]})(l.slice(o)),r+=t[0],o+=t[1]):r+=h(e)+"<br>"),o++)}return r},clean(r){return[[/!\[(.*?)\]\((.*?)\)/g,"$1"],[/\[([^\]]+)\]\(((?:[^()\\]|\\.)+|\((?:[^()\\]|\\.)*\))*\)/g,"$1"],[/\*\*(.+?)\*\*/g,"$1"],[/\*(.+?)\*/g,"$1"],[/~~(.+?)~~/g,"$1"],[/~(.+?)~/g,"$1"],[/\^(.+?)\^/g,"$1"],[/`(.+?)`/g,"$1"],[/__(.+?)__/g,"$1"],[/_(.+?)_/g,"$1"],[/\{(.+?)\|(.+?)\}/g,"$1"],[/\:([a-zA-Z0-9_-]+?)\:/g,""],[/\[\[(.+?)\]\]/g,""],[/---/g,""],[/^>\s?/gm,""],[/^(\s*)([-*+]|[0-9]+\.)\s+/gm,""],[/^\|(.+)\|$/gm,""],[/^#{1,6}\s*/gm,""],[/^:::\s*(\w+)(?:\s+.*)?$/gm,""],[/^:::\s*$/gm,""],[/^```.*$/gm,""],[/^```$/gm,""],[/<\/?[^>]+>/g,""]].forEach(([e,t])=>r=r.replace(e,t)),r},preview(e){let t=e.split("\n"),r=[],o;for(o of t){if("[more]"==o.trim().toLowerCase())break;r.push(o)}return this.clean(r.join("\n").trim()).trim().replace(/\n/g," ")},meta(e){let t={},r=e.trim().split("\n"),o=0,a;if("---"==r[0].trim()){for(o++;o<r.length&&"---"!=r[o].trim();)(a=r[o].trim().match(/^(\w+):\s*(.+)$/))&&(t[a[1]]=a[2]),o++;o++}return t.tags&&(t.tags=t.tags.split(",").map(e=>e.trim())),t.body=r.slice(o).join("\n").trim(),t},async ogp(e){var t=await(await fetch("https://corsproxy.io/?"+e)).text(),t=(new DOMParser).parseFromString(t,"text/html"),r={};for(const l of Array.from(t.head.querySelectorAll("meta[property]"))){var o=l.getAttribute("property"),a=l.getAttribute("content");o&&a&&(r[o]=a)}return r["og:title"]||=t.querySelector("title")?.textContent?.trim(),r["og:description"]||=t.querySelector('meta[name="description"]')?.getAttribute("content")?.trim(),r.ori=e,r},async hydrate(){for(const t of document.querySelectorAll(".linkcard-placeholder")){var e={...await this.ogp(t.getAttribute("href"))};t.outerHTML=this.linkcard(e["og:title"]||e["twitter:title"]||"リンク",e["og:description"]||e["twitter:description"]||"",e["og:image"]||e["twitter:image"],e["og:url"]||e["twitter:url"]||"",e.ori)}},linkcard(e,t,r,o,a,l="linkcard"){return`<a href=${a=a||o} class='${l}'target=_blank rel='noopener noreferrer'><span><div class='lttl nowrap'>${e}</div><div class='ldsc nowrap'>${t}</div>${o?`<div class='lurl nowrap'>${o}</div>`:""}</span>${r?`<img src='${r}'alt='${e}'>`:""}</a>`.trim()},genToc(){return this.toc.map(e=>`<a href="#${e.id}"class=toc-${e.level}>${e.text}</a>`)}},openModal=e=>{var t=document.querySelector(".modal");console.log(t),t.innerHTML=`<img src="${e}">`,t.style.display="flex"},closeModal=e=>{console.log("hi"),document.querySelector(".modal").style.display="none"};async function render(){var e=document.getElementById("source")?.textContent||"",t=modoki.meta(e),e=modoki.decode(t.body),r=await(await fetch(t.template||"/templates/default.html")).text(),o=(new DOMParser).parseFromString(r,"text/html"),a=(e,o)=>(e=(e=(e=e.replace(/\{if (\w+)\}([\s\S]*?)\{\/if\}/g,(e,t,r)=>o[t]?r:"")).replace(/\{tags\}/g,e=>Array.isArray(o.tags)?o.tags.map(e=>`<a href="/index.html#tag=${encodeURIComponent(e)}">#${e}</a>`).join(" "):"")).replace(/\{toc\}/g,e=>modoki.genToc().join(""))).replace(/\{(\w+)\}/g,(e,t)=>o[t]||"");for(const s of o.head.children){var l=s.cloneNode(!0);for(const d of["content","href"])l.hasAttribute(d)&&l.setAttribute(d,a(l.getAttribute(d),t));var i=s.tagName.toLowerCase(),i="meta"==i&&l.hasAttribute("name")?`meta[name="${l.getAttribute("name")}"]`:"link"==i&&l.hasAttribute("href")?`link[href="${l.getAttribute("href")}"]`:"title"==i?"title":null;i&&document.head.querySelector(i)||document.head.appendChild(l)}r=a(r,{...t,body:e});document.documentElement.innerHTML=r;for(const m of o.querySelectorAll("script")){var n=document.createElement("script"),c=m.src?"src":"textContent";n[c]=a(m[c],t),document.body.appendChild(n)}await loadCommon("#foot",t.foot||"/templates/foot.html"),await modoki.hydrate(),document.querySelectorAll("img:not(.linkcard img):not(a img)").forEach(t=>{var e=document.createElement("div");e.className="img-wrapper",e.addEventListener("click",e=>openModal(t.src)),t.parentNode.insertBefore(e,t),e.appendChild(t)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",render):render();let c=null;onscroll=onresize=e=>{let t=[...document.querySelectorAll("main h1[id],main h2[id]")],r=scrollY,o=innerHeight,a=r+.4*o,l=null;for(let e=0;e<t.length;e++){var i,n=r+t[e].getBoundingClientRect().top;0==e?n-r<.4*o&&(l=t[e].id):(i=e+1<t.length?r+t[e+1].getBoundingClientRect().top:document.body.scrollHeight,n<=a&&a<=i&&(l=t[e].id))}var s;l!=c&&(c=l,document.querySelectorAll(".toc a").forEach(e=>e.classList.remove("active")),c)&&(s=document.querySelector(`.toc a[href="#${c}"]`))&&s.classList.add("active")},onresize();